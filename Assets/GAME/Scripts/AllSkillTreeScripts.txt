// ----- File: ST_Manager.cs -----
using UnityEngine;
using TMPro;

[DisallowMultipleComponent]
public class ST_Manager : MonoBehaviour
{
    [Header("Central API for the Skill Tree system")]
    [Header("References")]
    public ST_Slots[] st_Slots;
    public TMP_Text skillPointsText;
    public P_Exp p_Exp;
    public C_StatsManager statsManager; // <-- New reference

    private P_InputActions input;

    [Header("UI Toggle")]
    public CanvasGroup skillsCanvas;
    public bool panelToggle = false;

    void Awake()
    {
        // Auto-wire UI components if not assigned in inspector
        p_Exp           ??= FindFirstObjectByType<P_Exp>();
        statsManager    ??= FindFirstObjectByType<C_StatsManager>();
        skillsCanvas    ??= GetComponent<CanvasGroup>();
        skillPointsText ??= GetComponentInChildren<TMP_Text>();

        if (!p_Exp)             Debug.LogError($"{name}: P_Exp missing in ST_Manager.", this);
        if (!statsManager)      Debug.LogError($"{name}: C_StatsManager missing in ST_Manager.", this);
        if (!skillsCanvas)      Debug.LogError($"{name}: SkillsCanvas missing in ST_Manager.", this);
        if (!skillPointsText)   Debug.LogError($"{name}: skillPointsText missing in ST_Manager.", this);

        input = new P_InputActions();
        input.UI.ToggleSkillTree.Enable();

        // start closed
        SetOpen(panelToggle);
    }

    void OnEnable()
    {
        p_Exp.OnSPChanged           += HandleSPChanged;
        p_Exp.OnLevelUp             += HandleLevelUp;

        ST_Slots.OnSkillUpgraded    += HandleSkillUpgraded;
        ST_Slots.OnSkillMaxed       += HandleSkillMaxed;
    }

    void OnDisable()
    {
        p_Exp.OnSPChanged           -= HandleSPChanged;
        p_Exp.OnLevelUp             -= HandleLevelUp;

        ST_Slots.OnSkillUpgraded    -= HandleSkillUpgraded;
        ST_Slots.OnSkillMaxed       -= HandleSkillMaxed;
    }
    
    // Initialize skill buttons and UI state
    void Start()
    {
        foreach (var slot in st_Slots)
        {
            slot.skillButton.onClick.AddListener(() => TryToUpgrade(slot));
        }

        // Initial UI state
        HandleSPChanged(p_Exp.skillPoints);
    }

    // Toggle skill tree UI with input
    void Update()
    {
        if (input.UI.ToggleSkillTree.WasPressedThisFrame())
            SetOpen(!panelToggle);
    }

    // Open/close the skill tree UI
    void SetOpen(bool open)
    {
        panelToggle = open;

        Time.timeScale = open ? 0f : 1f;
        skillsCanvas.alpha = open ? 1f : 0f;
        skillsCanvas.interactable = open;
        skillsCanvas.blocksRaycasts = open;
    }

    // Called when a skill button is clicked
    void TryToUpgrade(ST_Slots slot)
    {
        // ST_Manager should check these first
        if (!slot.isUnlocked) return;
        if (slot.currentLevel >= slot.st_skillSO.maxLevel) return;

        if (p_Exp.TrySpendSkillPoints(1))
            slot.UpgradeTheSkill();
    }

    // Called when a skill is upgraded
    void HandleSkillUpgraded(ST_Slots slot)
    {
        var so = slot.st_skillSO;
        if (!so) return;

        // Apply all modifiers from the skill upgrade
        foreach (StatEffect modifier in so.modifiers)
        {
            // Note: The modifier's value is the amount *per level*.
            statsManager.ApplyModifier(modifier);
        }
    }

    // Called when a skill is maxed out
    void HandleSkillMaxed(ST_Slots maxedSlot)
    {
        // When a skill maxed -> Check only its direct children to see if they can be unlocked
        foreach (var slot in st_Slots)
        {
            // Check if this slot is a child of the maxed slot
            if (!slot.isUnlocked && slot.prerequisiteSkillSlots.Contains(maxedSlot))
            {
                // Try to unlock it
                slot.TryUnlock();
            }
        }
    }

    // Called when skill points changed
    void HandleSPChanged(int sp)
    {
        skillPointsText.text = "SKILL POINTS: " + sp;
    }

    // Called when player levels up
    void HandleLevelUp(int newLevel)
    {
        HandleSPChanged(p_Exp.skillPoints);
    }
}

// ----- File: ST_SkillSO.cs -----
using UnityEngine;
using System.Collections.Generic; // Required for List

[CreateAssetMenu(fileName = "NewSkill", menuName = "SkillTree")]
public class ST_SkillSO : ScriptableObject
{
    [Header("Meta")]
    public string skillName = "Auto Filled";
    public Sprite skillIcon;
    [Min(1)] public int maxLevel = 1;

    [Header("Effects Per Level")]
    public List<StatEffect> modifiers;

    private void OnValidate()
    {
        if (skillName != name)
            skillName = name;
    }
}

// ----- File: ST_Slot.cs -----
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System;
using System.Collections.Generic;

public class ST_Slots : MonoBehaviour
{
    [Header("Slot represents one skill in the Skill Tree")]
    [Header("Gate")]
    public List<ST_Slots> prerequisiteSkillSlots;

    [Header("Skill Data")]
    public ST_SkillSO st_skillSO;

    [Header("State")]
    public int  currentLevel;
    public bool isUnlocked;

    [Header("UI")]
    public Image   SkillIcon;
    public Button  skillButton;
    public TMP_Text skillLevelText;

    public static event Action<ST_Slots> OnSkillUpgraded;
    public static event Action<ST_Slots> OnSkillMaxed;

    void Awake()
    {
        // Auto-wire UI components if not assigned in inspector
        SkillIcon ??= GetComponentInChildren<Image>();
        skillButton ??= GetComponent<Button>();
        skillLevelText ??= GetComponentInChildren<TMP_Text>();

        if (!st_skillSO) Debug.LogError($"{name}: ST_SkillSO is not assigned on {GetType().Name}.", this);
        if (!SkillIcon) Debug.LogWarning($"{name}: SkillIcon is not assigned.", this);
        if (!skillButton) Debug.LogWarning($"{name}: skillButton is not assigned.", this);
        if (!skillLevelText) Debug.LogWarning($"{name}: skillLevelText is not assigned.", this);

        prerequisiteSkillSlots ??= new List<ST_Slots>();

        UpdateUI();
    }

    void OnValidate()
    {
        if (st_skillSO != null && skillLevelText != null) UpdateUI();
    }

    // Called by ST_Manager after it successfully spends a point
    public void UpgradeTheSkill()
    {
        // ST_Manager already check these first
        // Avoid cheat/debug buttons go over limits
        if (!isUnlocked) return;
        if (currentLevel >= st_skillSO.maxLevel) return;

        // Upgrade and fire events
        currentLevel++;
        OnSkillUpgraded?.Invoke(this);
        if (currentLevel >= st_skillSO.maxLevel) OnSkillMaxed?.Invoke(this);

        UpdateUI();
    }

    // This method now checks all prerequisites and unlocks the skill if they are met
    // It returns true if the skill was newly unlocked
    public bool TryUnlock()
    {
        // 1/ Don't do anything if the skill is already unlocked
        if (isUnlocked)
        {
            return false;
        }

        // 2/ Check if all prerequisite skills are maxed out
        foreach (var prereq in prerequisiteSkillSlots)
        {
            if (prereq.currentLevel < prereq.st_skillSO.maxLevel)
            {
                return false;
            }
        }

        // 3/ All prerequisites are met! Unlock the skill.
        isUnlocked = true;
        UpdateUI();
        return true;
    }

    void UpdateUI()
    {
        SkillIcon.sprite = st_skillSO.skillIcon;

        if (isUnlocked)
        {
            skillButton.interactable = true;
            skillLevelText.text = currentLevel + "/" + st_skillSO.maxLevel;
            SkillIcon.color = Color.white;
        }
        else
        {
            skillButton.interactable = false;
            skillLevelText.text = "Locked";
            SkillIcon.color = Color.gray;
        }
    }
}

