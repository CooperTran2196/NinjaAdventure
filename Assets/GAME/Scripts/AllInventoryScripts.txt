// ----- File: INV_ItemSO.cs -----
using UnityEngine;
using System.Collections.Generic;

[CreateAssetMenu(fileName = "INV_ItemSO", menuName = "Item")]
public class INV_ItemSO : ScriptableObject
{
    public string itemName = "Auto Filled";
    [TextArea] public string itemDescription;
    public Sprite icon;
    public int stackSize = 3;

    [Header("Flags")]
    public bool isGold;

    [Header("Item Effects")]
    public List<StatEffect> modifiers;

    private void OnValidate()
    {
        if (itemName != name)
            itemName = name;
    }
}

// ----- File: INV_Loot.cs -----
using System;
using UnityEngine;

[ExecuteAlways] // lets OnEnable run in Edit Mode so the icon updates in Inspector
public class INV_Loot : MonoBehaviour
{
    public static event Action<INV_ItemSO, int> OnItemLooted;

    [Header("References")]
    public INV_ItemSO inv_ItemSO;

    SpriteRenderer sr;
    Animator anim;

    [Header("Data")]
    public int quantity = 1;
    public bool canBePickedUp = true; // false when we drop it from inventory

    CircleCollider2D trigger;

    void Awake()
    {
        sr      ??= GetComponentInChildren<SpriteRenderer>();
        anim    ??= GetComponent<Animator>();
        trigger ??= GetComponent<CircleCollider2D>();

        if (!sr)      Debug.LogError($"{name}: SpriteRenderer missing.", this);
        if (!anim)    Debug.LogError($"{name}: Animator missing.", this);
        if (!trigger) Debug.LogError($"{name}: CircleCollider2D missing.", this);
    }

    void OnEnable() => RefreshAppearance();

    // Called by INV_Manager when spawning overflow/right-click drops
    public void Initialize(INV_ItemSO so, int qty)
    {
        inv_ItemSO = so;
        quantity = qty;
        canBePickedUp = false; // avoid instant repick
        RefreshAppearance();
    }

    void RefreshAppearance()
    {
        if (!sr || !inv_ItemSO) return;

        sr.sprite = inv_ItemSO.icon;
        gameObject.name = inv_ItemSO.itemName;
    }

    void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player") || !canBePickedUp) return;

        trigger.enabled = false;
        OnItemLooted?.Invoke(inv_ItemSO, quantity);
        anim?.SetTrigger("Pickup");
        Destroy(gameObject, 0.5f); // Match animation length
    }

    void OnTriggerExit2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;

        canBePickedUp = true;
    }
}

// ----- File: INV_Manager.cs -----
// Assets/GAME/Scripts/INV/INV_InventoryManager.cs
using UnityEngine;
using TMPro;

[DisallowMultipleComponent]
public class INV_Manager : MonoBehaviour
{
    [Header("Central API for the Inventory system")]
    [Header("References")]
    public C_StatsManager statsManager; // <-- New reference

    public TMP_Text goldText;
    public GameObject lootPrefab;
    public Transform player;
    public int gold;
    public INV_Slots[] inv_Slots;

    void OnEnable()  => INV_Loot.OnItemLooted += AddItem;
    void OnDisable() => INV_Loot.OnItemLooted -= AddItem;

    void Awake()
    {
        statsManager ??= FindFirstObjectByType<C_StatsManager>();
        if (!statsManager) Debug.LogError($"{name}: C_StatsManager missing.", this);
    }

    void Start()
    {
        foreach (var slot in inv_Slots) slot.UpdateUI();
        UpdateGoldText();
    }

    public void AddItem(INV_ItemSO inv_ItemSO, int quantity)
    {
        if (inv_ItemSO.isGold)
        {
            gold += quantity;
            UpdateGoldText();
            return;
        }

        // Stack into existing slots of the same item
        foreach (var slot in inv_Slots)
        {
            if (slot.item == inv_ItemSO && slot.quantity < inv_ItemSO.stackSize)
            {
                int availableSpace = inv_ItemSO.stackSize - slot.quantity;
                int amountToAdd    = Mathf.Min(availableSpace, quantity);

                slot.quantity += amountToAdd;
                quantity      -= amountToAdd;

                slot.UpdateUI();
                if (quantity <= 0) return;
            }
        }

        // Fill empty slots
        foreach (var slot in inv_Slots)
        {
            if (slot.item == null)
            {
                int amountToAdd = Mathf.Min(inv_ItemSO.stackSize, quantity);

                slot.item     = inv_ItemSO;
                slot.quantity = amountToAdd;
                slot.UpdateUI();

                quantity -= amountToAdd;
                if (quantity <= 0) return;
            }
        }

        // No room -> drop overflow at player
        if (quantity > 0) DropLoot(inv_ItemSO, quantity);
    }

    void UpdateGoldText()
    {
        goldText.text = gold.ToString();
    }

    public void UseItem(INV_Slots slot)
    {
        if (slot.item == null || slot.item.modifiers.Count == 0) return;

        // Apply all modifiers from the item
        foreach (var modifier in slot.item.modifiers)
        {
            statsManager.ApplyModifier(modifier);
        }

        // Consume the item
        slot.quantity -= 1;
        if (slot.quantity <= 0) slot.item = null;
        slot.UpdateUI();
    }

    // Drops 1 item from the given slot at player position
    public void DropItemFromSlot(INV_Slots slot)
    {
        DropLoot(slot.item, 1);
        slot.quantity -= 1;
        if (slot.quantity <= 0) slot.item = null;
        slot.UpdateUI();
    }

    // Spawns loot prefab at player position with given item & quantity
    void DropLoot(INV_ItemSO item, int qty)
    {
        var go = Instantiate(lootPrefab, player.position, Quaternion.identity);
        var loot = go.GetComponent<INV_Loot>();
        loot.Initialize(item, qty); // sets sprite/name & canBePickedUp=false
    }
}

// ----- File: INV_Slots.cs -----
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.EventSystems;

public class INV_Slots : MonoBehaviour, IPointerClickHandler
{
    [Header("Data")]
    public INV_ItemSO item;
    public int quantity;

    [Header("UI")]
    public Image itemImage;
    public TMP_Text amountText;

    INV_Manager inv;
    static SHOP_Manager activeShop;

    void Awake()
    {

        itemImage  ??= transform.Find("Icon")?.GetComponent<Image>();
        amountText ??= transform.Find("QuantityText")?.GetComponent<TMP_Text>();
        inv        ??= GetComponentInParent<INV_Manager>();

        if (!itemImage)  Debug.LogError($"{name}: Item Image missing.", this);
        if (!amountText) Debug.LogError($"{name}: Amount Text missing.", this);
        if (!inv)        Debug.LogError($"{name}: INV_Manager missing in parent.", this);
    }

    void OnEnable()  => SHOP_Manager.OnShopStateChanged += HandleShopStateChanged;
    void OnDisable() => SHOP_Manager.OnShopStateChanged -= HandleShopStateChanged;

    void HandleShopStateChanged(SHOP_Manager shop, bool isOpen)
    {
        activeShop = isOpen ? shop : null;
    }

    public void UpdateUI()
    {
        if (item != null)
        {
            itemImage.enabled = true;
            itemImage.sprite = item.icon;
            amountText.text = quantity.ToString();
        }
        else
        {
            itemImage.enabled = false;
            amountText.text = "";
        }
    }

    public void OnPointerClick(PointerEventData e)
    {
        if (item == null || quantity <= 0) return;

        // Shop open: LEFT = sell 1; disable use/drop while open
        if (activeShop != null)
        {
            if (e.button == PointerEventData.InputButton.Left)
            {
                activeShop.SellItem(item);
                quantity -= 1;
                if (quantity <= 0) item = null;
                UpdateUI();
            }
            return;
        }

        // Shop closed: normal behavior
        if (e.button == PointerEventData.InputButton.Left)
            inv.UseItem(this);
        else if (e.button == PointerEventData.InputButton.Right)
            inv.DropItemFromSlot(this);
    }
}

// ----- File: SHOP_Manager.cs -----
// Assets/GAME/Scripts/INV/SHOP_Manager.cs
using System;
using System.Collections.Generic;
using UnityEngine;

public class SHOP_Manager : MonoBehaviour
{
    public static event Action<SHOP_Manager, bool> OnShopStateChanged;

    [Header("Shopping List")]
    [SerializeField] List<ShopItem> shopItems = new();   // per-shopkeeper list

    [Header("Slots")]
    [SerializeField] SHOP_Slot[] shopSlots;              // set in Inspector

    [Header("Inventory Link (for buy/sell step)")]
    public INV_Manager inv;                              // drag your Inventory Canvas

    void Awake()
    {
        // Auto-wire inventory if not assigned (optional)
        inv ??= FindFirstObjectByType<INV_Manager>();

        if (!inv)
            Debug.LogError($"{name}: INV_Manager reference missing on SHOP_Manager.", this);
        if (shopSlots == null || shopSlots.Length == 0)
            Debug.LogWarning($"{name}: No shopSlots assigned.", this);
    }

    void Start()
    {
        PopulateShopItems();
        OnShopStateChanged?.Invoke(this, true); // open by default for now
    }

    void OnDisable() => OnShopStateChanged?.Invoke(this, false);

    public void PopulateShopItems()
    {
        // fill used slots
        int count = Mathf.Min(shopItems.Count, shopSlots.Length);
        for (int i = 0; i < count; i++)
        {
            var data = shopItems[i];
            var slot = shopSlots[i];
            slot.gameObject.SetActive(true);
            slot.Initialize(data.inv_ItemSO, data.price);
        }

        // turn off the rest
        for (int i = count; i < shopSlots.Length; i++)
            shopSlots[i].gameObject.SetActive(false);
    }

    // ---- next-video hooks (already here so you donâ€™t refactor later) ----
    public void TryBuyItem(INV_ItemSO inv_ItemSO, int price)
    {
        if (inv_ItemSO == null) return;
        if (!inv) return;
        if (inv.gold < price) return;
        if (!HasSpace(inv_ItemSO)) return;

        inv.gold -= price;
        inv.goldText.text = inv.gold.ToString();
        inv.AddItem(inv_ItemSO, 1);
    }

    public void SellItem(INV_ItemSO inv_ItemSO)
    {
        if (inv_ItemSO == null) return;
        if (!inv) return;
        int price = GetPrice(inv_ItemSO);
        if (price <= 0) return;

        inv.gold += price;
        inv.goldText.text = inv.gold.ToString();
        // INV_Slots handles decreasing quantity & UpdateUI on click
    }

    bool HasSpace(INV_ItemSO inv_ItemSO)
    {
        // same item with room
        foreach (var slot in inv.inv_Slots)
            if (slot.item == inv_ItemSO && slot.quantity < inv_ItemSO.stackSize) return true;

        // empty slot
        foreach (var slot in inv.inv_Slots)
            if (slot.item == null) return true;

        return false;
    }

    int GetPrice(INV_ItemSO inv_ItemSO)
    {
        for (int i = 0; i < shopItems.Count; i++)
            if (shopItems[i].inv_ItemSO == inv_ItemSO) return shopItems[i].price;
        return 0;
    }

    [Serializable]
    public class ShopItem
    {
        public INV_ItemSO inv_ItemSO;
        public int price = 1;
    }
}

// ----- File: SHOP_Slot.cs -----
// Assets/GAME/Scripts/INV/SHOP_Slot.cs
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class SHOP_Slot : MonoBehaviour
{
    [Header("Runtime Data")]
    public INV_ItemSO inv_ItemSO { get; private set; }
    public int price { get; private set; }

    [Header("UI")]
    public Image icon;         // child "Icon"
    public TMP_Text nameText;  // child "NameText"
    public TMP_Text priceText; // child "PriceText"

    [Header("Refs")]
    public SHOP_Manager shop;  // parent manager

    void Awake()
    {
        shop      ??= GetComponentInParent<SHOP_Manager>();
        icon      ??= transform.Find("Icon")?.GetComponent<Image>();
        nameText  ??= transform.Find("NameText")?.GetComponent<TMP_Text>();
        priceText ??= transform.Find("PriceText")?.GetComponent<TMP_Text>();

        if (!shop)      Debug.LogError($"{name}: SHOP_Manager missing in parent.", this);
        if (!icon)      Debug.LogError($"{name}: Icon Image missing.", this);
        if (!nameText)  Debug.LogError($"{name}: NameText TMP missing.", this);
        if (!priceText) Debug.LogError($"{name}: PriceText TMP missing.", this);
    }

    // called by SHOP_Manager at startup
    public void Initialize(INV_ItemSO newItemSO, int newPrice)
    {
        inv_ItemSO = newItemSO;
        price  = newPrice;

        icon.enabled = true;
        icon.sprite  = inv_ItemSO.icon;
        nameText.text  = inv_ItemSO.itemName;
        priceText.text = price.ToString();
    }

    // keep this so the next video (buy) just works
    public void OnBuyButtonClicked()
    {
        shop.TryBuyItem(inv_ItemSO, price);
    }
}

