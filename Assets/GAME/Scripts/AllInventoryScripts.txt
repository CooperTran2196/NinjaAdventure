// ----- File: INV_ItemInfo.cs -----
using UnityEngine;
using TMPro;
using System.Collections.Generic;

public class INV_ItemInfo : MonoBehaviour
{
    [Header("Showing Info of Items")]
    [Header("References")]
    public CanvasGroup canvasGroup;
    public RectTransform rectTransform;

    public TMP_Text itemNameText;
    public TMP_Text itemDescText;
    public TMP_Text statLinePrefab;
    
    public Transform statContainer;

    public Vector2 offset = new Vector2(12f, -8f);

    void Awake()
    {
        canvasGroup ??= GetComponent<CanvasGroup>();
        rectTransform ??= GetComponent<RectTransform>();

        if (!canvasGroup) Debug.LogError($"{name}: CanvasGroup is missing in INV_ItemInfo");
        if (!rectTransform) Debug.LogError($"{name}: RectTransform is missing in INV_ItemInfo");
        // if (!itemNameText) Debug.LogError("INV_ItemInfo: itemNameText missing.", this);
        if (!itemDescText) Debug.LogError($"{name}: itemDescText is missing in INV_ItemInfo");
        if (!statLinePrefab) Debug.LogError($"{name}: statLinePrefab is missing in INV_ItemInfo");
        if (!statContainer)  Debug.LogError($"{name}: statContainer is missing in INV_ItemInfo");

    }

    public void Show(INV_ItemSO itemSO)
    {
        // make visible
        canvasGroup.alpha = 1f;

        // header texts
        if (itemNameText) itemNameText.text = itemSO ? itemSO.itemName : string.Empty;
        itemDescText.text = itemSO.description;

        // rebuild stat lines
        ClearStatLines();
        if (itemSO)
        {
            var outLines = BuildStatLines(itemSO);
            for (int i = 0; i < outLines.Count; i++)
            {
                var line = Instantiate(statLinePrefab, statContainer);
                line.text = outLines[i];
            }
        }
    }

    // Hide and clear
    public void Hide()
    {
        canvasGroup.alpha = 0f;
    }

    public void FollowMouse(Vector2 screenPos)
    {
        rectTransform.position = (Vector3)screenPos + (Vector3)offset;
    }

    // Remove all existing stat lines
    void ClearStatLines()
    {
        for (int i = statContainer.childCount - 1; i >= 0; i--)
            Destroy(statContainer.GetChild(i).gameObject);
    }

    // Build formatted stat description lines for the provided item
    List<string> BuildStatLines(INV_ItemSO inv_ItemSO)
    {
        var outLines = new List<string>();

        if (inv_ItemSO.isGold)
        {
            outLines.Add("A pile of gold coins.");
            return outLines;
        }

        if (inv_ItemSO.StatEffectList != null)
        {
            for (int i = 0; i < inv_ItemSO.StatEffectList.Count; i++)
            {
                var effects = inv_ItemSO.StatEffectList[i];
                string line;
                switch (effects.statName)
                {
                    case StatName.Heal:          line = $"Heals {effects.Value} HP"; break;
                    case StatName.MaxHealth:     line = $"+{effects.Value} Max HP"; break;
                    case StatName.AttackDamage:  line = $"+{effects.Value} Attack Damage"; break;
                    case StatName.AbilityPower:  line = $"+{effects.Value} Ability Power"; break;
                    case StatName.MoveSpeed:     line = $"+{effects.Value} Move Speed"; break;
                    case StatName.Armor:         line = $"+{effects.Value} Armor"; break;
                    case StatName.MagicResist:   line = $"+{effects.Value} Magic Resist"; break;
                    case StatName.Lifesteal:     line = $"+{effects.Value}% Lifesteal"; break;
                    default:                     line = $"+{effects.Value} {effects.statName}"; break;
                }
                if (effects.Duration > 1) line = $"{line} in ({effects.Duration}s)";
                outLines.Add(line);
            }
        }
        return outLines;
    }
}

// ----- File: INV_ItemSO.cs -----
using UnityEngine;
using System.Collections.Generic;

[CreateAssetMenu(fileName = "INV_ItemSO", menuName = "Item")]
public class INV_ItemSO : ScriptableObject
{
    [Header("Item Data")]
    public string itemName = "Auto Filled by OnValidate";
    [TextArea] public string description;
    public Sprite image;
    public int stackSize = 3;
    public int price = 1;

    [Header("Flags")]
    public bool isGold;

    [Header("Item Effects")]
    public List<P_StatEffect> StatEffectList;

    // Auto-update name in Editor
    private void OnValidate()
    {
        itemName = name;
    }
}

// ----- File: INV_Loot.cs -----
using System;
using UnityEngine;

[ExecuteAlways] // lets OnEnable run in Edit Mode so the icon updates in Inspector
public class INV_Loot : MonoBehaviour
{
    [Header("MUST have components for each loot prefab")]
    [Header("References")]
    public INV_ItemSO itemSO;
    SpriteRenderer sr;
    Animator anim;
    CircleCollider2D trigger;

    [Header("Data")]
    public int quantity = 1;
    public bool canBePickedUp = true; // false when we drop it from inventory

    public static event Action<INV_ItemSO, int> OnItemLooted;

    void Awake()
    {
        sr      ??= GetComponentInChildren<SpriteRenderer>();
        anim    ??= GetComponent<Animator>();
        trigger ??= GetComponent<CircleCollider2D>();

        if (!sr)      Debug.LogError($"{name}: SpriteRenderer is missing in INV_Loot");
        if (!anim)    Debug.LogError($"{name}: Animator is missing in INV_Loot");
        if (!trigger) Debug.LogError($"{name}: CircleCollider2D is missing in INV_Loot");
    }

    // Run in Edit Mode to update sprite in Inspector
    void OnEnable() => RefreshAppearance();

    // Called by INV_Manager when spawning overflow/right-click drops
    public void Initialize(INV_ItemSO itemSO, int qty)
    {
        this.itemSO = itemSO;
        quantity = qty;
        canBePickedUp = false; // avoid instant repick
        RefreshAppearance();
    }

    // Update sprite and name
    void RefreshAppearance()
    {
        sr.sprite = itemSO.image;
        gameObject.name = itemSO.itemName;
    }

    // Pickup when player enters trigger
    void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player") || !canBePickedUp) return;

        trigger.enabled = false;
        OnItemLooted?.Invoke(itemSO, quantity);
        anim.SetTrigger("Pickup");
        Destroy(gameObject, 0.5f); // MUST Match animation length
    }

    // re-enable pickup when player leaves trigger (for drops)
    void OnTriggerExit2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;

        canBePickedUp = true;
    }
}

// ----- File: INV_Manager.cs -----
using UnityEngine;
using TMPro;

[DisallowMultipleComponent]
public class INV_Manager : MonoBehaviour
{
    public static INV_Manager Instance { get; private set; }

    [Header("Central API for the Inventory system, depend on P_StatsManager")]
    [Header("References")]
    public P_StatsManager p_statsManager;

    [Header("MUST wire MANUALLY in Inspector")]
    public TMP_Text goldText;
    public GameObject lootPrefab;
    public Transform player;

    public int gold;
    public INV_Slots[] inv_Slots;

    void OnEnable() => INV_Loot.OnItemLooted += AddItem;
    void OnDisable() => INV_Loot.OnItemLooted -= AddItem;

    void Awake()
    {
        if (Instance != null) { Destroy(gameObject); return; }
        Instance = this;
        DontDestroyOnLoad(gameObject);

        p_statsManager ??= FindFirstObjectByType<P_StatsManager>();

        if (!p_statsManager) Debug.LogError($"{name}: P_StatsManager is missing in INV_Manager");
    }

    // Update all slots & gold text at start
    void Start()
    {
        foreach (var slot in inv_Slots) slot.UpdateUI();
        UpdateGoldText();
    }

    // Adds item to inventory, stacking into existing slots first
    public void AddItem(INV_ItemSO itemSO, int quantity)
    {
        // Gold is special
        if (itemSO.isGold)
        {
            gold += quantity;
            UpdateGoldText();
            return;
        }

        // Stack into existing slots of the same item
        foreach (var slot in inv_Slots)
        {
            // same item and not full
            if (slot.itemSO == itemSO && slot.quantity < itemSO.stackSize)
            {
                int availableSpace = itemSO.stackSize - slot.quantity;
                int amountToAdd = Mathf.Min(availableSpace, quantity);

                slot.quantity += amountToAdd;
                quantity -= amountToAdd;

                slot.UpdateUI();
                if (quantity <= 0) return;
            }
        }

        // Fill empty slot
        foreach (var slot in inv_Slots)
        {
            if (slot.itemSO == null)
            {
                int amountToAdd = Mathf.Min(itemSO.stackSize, quantity);

                slot.itemSO = itemSO;
                slot.quantity = amountToAdd;
                slot.UpdateUI();

                quantity -= amountToAdd;
                if (quantity <= 0) return;
            }
        }

        // No room -> drop overflow at player
        if (quantity > 0) DropItem(itemSO, quantity);
    }

    // Update gold text UI
    void UpdateGoldText()
    {
        goldText.text = gold.ToString();
    }

    // Uses the item in the given slot
    public void UseItem(INV_Slots slot)
    {
        // nothing to use
        if (slot.itemSO == null || slot.itemSO.StatEffectList.Count == 0) return;

        // Apply all StatEffectList from the item
        foreach (var modifier in slot.itemSO.StatEffectList)
        {
            p_statsManager.ApplyModifier(modifier);
        }

        // Consume the item
        slot.quantity -= 1;
        if (slot.quantity <= 0) slot.itemSO = null;
        slot.UpdateUI();
    }

    // Spawns loot prefab at player position with given item & quantity
    public void DropItem(INV_ItemSO itemSO, int quantity)
    {
        if (!itemSO) return;
        var go = Instantiate(lootPrefab, player.position, Quaternion.identity);
        var loot = go.GetComponent<INV_Loot>();
        loot.Initialize(itemSO, quantity); // sets sprite/name & canBePickedUp=false
    }
    // Do we have at least 1 of this item?
    public bool HasItem(INV_ItemSO itemSO)
    {
        // Adjust the array name if yours differs (e.g., slots, itemSlots, inventorySlots)
        foreach (var slot in inv_Slots)
        {
            if (slot.itemSO == itemSO && slot.quantity > 0)
                return true;
        }
        return false;
    }

}

// ----- File: INV_Slots.cs -----
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.EventSystems;

public class INV_Slots : MonoBehaviour, IPointerClickHandler
{
    [Header("References")]
    INV_Manager inv_Manager;

    [Header("MUST have for each slot")]
    [Header("Data")]
    public INV_ItemSO itemSO;
    public int quantity;

    [Header("UI")]
    public Image itemImage;
    public TMP_Text amountText;

    static SHOP_Manager shop_Manager;

    void Awake()
    {
        itemImage ??= transform.Find("Icon")?.GetComponent<Image>();
        amountText ??= transform.Find("QuantityText")?.GetComponent<TMP_Text>();
        inv_Manager ??= GetComponentInParent<INV_Manager>();

        if (!itemImage)     Debug.LogError($"{name}: itemImage is missing in INV_Slots");
        if (!amountText)    Debug.LogError($"{name}: amountText is missing in INV_Slots");
        if (!inv_Manager)   Debug.LogError($"{name}: INV_Manager is missing in INV_Slots");
    }

    void OnEnable()  => SHOP_Keeper.OnShopStateChanged += HandleShopStateChanged;
    void OnDisable() => SHOP_Keeper.OnShopStateChanged -= HandleShopStateChanged;

    void HandleShopStateChanged(SHOP_Manager shop, bool isOpen)
    {
        shop_Manager = isOpen ? shop : null;
    }

    // update icon and amount text
    public void UpdateUI()
    {
        if (itemSO)
        {
            itemImage.enabled = true;
            itemImage.sprite = itemSO.image;
            amountText.text = quantity.ToString();
        }
        else
        {
            itemImage.enabled = false;
            amountText.text = "";
        }
    }

    // LEFT = use or sell; RIGHT = drop (ONLY IF shop closed)
    public void OnPointerClick(PointerEventData eventData)
    {
        if (itemSO == null) return;

        // Shop open: Right = sell 1; disable use/drop while open
        if (shop_Manager)
        {
            if (eventData.button == PointerEventData.InputButton.Right)
            {
                shop_Manager.SellItem(itemSO);
                quantity -= 1;
                if (quantity <= 0) itemSO = null;
                UpdateUI();
            }
            return;
        }
        // Shop closed: normal behavior
        else
        {
            if (eventData.button == PointerEventData.InputButton.Left)
                inv_Manager.UseItem(this);
            else if (eventData.button == PointerEventData.InputButton.Right)
            {
                inv_Manager.DropItem(itemSO, 1);
                quantity -= 1;
                if (quantity <= 0) itemSO = null;
                UpdateUI();
            }
        }
    }
}

// ----- File: SHOP_CategoryButtons.cs -----
using UnityEngine;

public class SHOP_CategoryButtons : MonoBehaviour
{
    public void OpenItemShop()
    {
        if (SHOP_Keeper.currentShopKeeper != null)
        {
            SHOP_Keeper.currentShopKeeper.OpenItemShop();
        }
    }

    public void OpenWeaponShop()
    {
        if (SHOP_Keeper.currentShopKeeper != null)
        {
            SHOP_Keeper.currentShopKeeper.OpenWeaponShop();
        }
    }

    public void OpenArmourShop()
    {
        if (SHOP_Keeper.currentShopKeeper != null)
        {
            SHOP_Keeper.currentShopKeeper.OpenArmourShop();
        }
    }
    
}

// ----- File: SHOP_Keeper.cs -----
using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.InputSystem;

public class SHOP_Keeper : MonoBehaviour
{
    [Header("References")]
    [SerializeField] Animator Anim;
    [SerializeField] CircleCollider2D trigger;
    public SHOP_Manager shop_Manager;
    public CanvasGroup shopCanvasGroup;
    public static SHOP_Keeper currentShopKeeper;

    bool playerInRange;
    bool isShopOpen = false;
    P_InputActions input;

    [SerializeField] private List<INV_ItemSO> shopItems;
    [SerializeField] private List<INV_ItemSO> shopWeapons;
    [SerializeField] private List<INV_ItemSO> shopArmors;

    public static event Action<SHOP_Manager, bool> OnShopStateChanged;

    void Awake()
    {
        Anim ??= GetComponentInChildren<Animator>(true);
        trigger ??= GetComponent<CircleCollider2D>();

        input = new P_InputActions();
        input.UI.ToggleShop.Enable();
    }

    void OnEnable() => input.Enable();
    void OnDisable() => input.Disable();

    void Update()
    {
        if (playerInRange && input.UI.ToggleShop.WasPressedThisFrame())
        {
            if (!isShopOpen)
            {
                Time.timeScale = 0; // Pause the game
                currentShopKeeper = this;
                isShopOpen = true;
                OnShopStateChanged?.Invoke(shop_Manager, true);
                shopCanvasGroup.alpha = 1; // Show the shop UI
                shopCanvasGroup.interactable = true;
                shopCanvasGroup.blocksRaycasts = true;
                OpenItemShop();

            }
            else
            {
                Time.timeScale = 1; // Resume the game
                currentShopKeeper = null;
                isShopOpen = false;
                OnShopStateChanged?.Invoke(shop_Manager, false);
                shopCanvasGroup.alpha = 0; // Hide the shop UI
                shopCanvasGroup.interactable = false;
                shopCanvasGroup.blocksRaycasts = false;
            }
        }
    }

    public void OpenItemShop()
    {
        shop_Manager.PopulateShopItems(shopItems);
    }

    public void OpenWeaponShop()
    {
        shop_Manager.PopulateShopItems(shopWeapons);
    }
    public void OpenArmourShop()
    {
        shop_Manager.PopulateShopItems(shopArmors);
    }

    // Detect player entering trigger area
    void OnTriggerEnter2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;
        playerInRange = true;
        Anim?.SetBool("PlayerInRange", true);
    }

    // Detect player exiting trigger area
    void OnTriggerExit2D(Collider2D other)
    {
        if (!other.CompareTag("Player")) return;
        playerInRange = false;
        Anim?.SetBool("PlayerInRange", false);
    }
}

// ----- File: SHOP_Manager.cs -----
using System;
using System.Collections.Generic;
using UnityEngine;

public class SHOP_Manager : MonoBehaviour
{
    [Header("Shopping List")]

    [Header("Slots")]
    [SerializeField] SHOP_Slot[] shop_Slots;

    [Header("Inventory Link (for buy/sell step)")]
    public INV_Manager inv_Manager;

    void Awake()
    {
        inv_Manager ??= FindFirstObjectByType<INV_Manager>();

        if (!inv_Manager)
            Debug.LogError($"{name}: INV_Manager is missing in SHOP_Manager");
        if (shop_Slots == null || shop_Slots.Length == 0)
            Debug.LogWarning("SHOP_Manager: No shopSlots assigned.", this);
    }

    public void PopulateShopItems(List<INV_ItemSO> inv_ItemSOList)
    {
        // fill used slots
        int count = Mathf.Min(inv_ItemSOList.Count, shop_Slots.Length);
        for (int i = 0; i < count; i++)
        {
            shop_Slots[i].gameObject.SetActive(true);
            shop_Slots[i].Initialize(inv_ItemSOList[i]);
        }

        // turn off the rest
        for (int i = count; i < shop_Slots.Length; i++)
            shop_Slots[i].gameObject.SetActive(false);
    }

    // Attempt to buy item, checking gold and space
    public void TryBuyItem(INV_ItemSO inv_ItemSO, int price)
    {
        if (inv_ItemSO == null) return;
        if (inv_Manager.gold < price) return;
        if (!HasSpace(inv_ItemSO)) return;

        inv_Manager.gold -= price;
        inv_Manager.goldText.text = inv_Manager.gold.ToString();
        inv_Manager.AddItem(inv_ItemSO, 1);
    }

    // Sell item from inventory to shop
    public void SellItem(INV_ItemSO itemSO)
    {
        if (itemSO.price <= 0)
        {
            Debug.LogWarning("SHOP_Manager: Cannot sell item with zero or negative price.", this);
            return;
        }

        // Update gold
        inv_Manager.gold += itemSO.price;
        inv_Manager.goldText.text = inv_Manager.gold.ToString();
        // INV_Slots handles decreasing quantity & UpdateUI on click
    }

    // Return T/F if there's space in inventory for this item
    bool HasSpace(INV_ItemSO itemSO)
    {
        // Loop through inventory slots
        foreach (var slot in inv_Manager.inv_Slots)
            // same item with room
            if (slot.itemSO == itemSO && slot.quantity < itemSO.stackSize)
                return true;
            // empty slot
            else if (slot.itemSO == null)
                return true;
        // No space found
        return false;
    }
}



// ----- File: SHOP_Slot.cs -----
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.EventSystems;

public class SHOP_Slot : MonoBehaviour, IPointerEnterHandler, IPointerExitHandler, IPointerMoveHandler
{
    [Header("References")]
    public SHOP_Manager shop_Manager;
    public INV_ItemInfo inv_ItemInfo;

    [Header("UI")]
    public TMP_Text itemNameText;
    public Image itemImage;
    public TMP_Text itemPriceText;

    [Header("Runtime Data")]
    public INV_ItemSO itemSO;
    public int price;

    void Awake()
    {
        shop_Manager     ??= GetComponentInParent<SHOP_Manager>();
        
        itemNameText    ??= transform.Find("itemNameText")?.GetComponent<TMP_Text>();
        itemImage       ??= transform.Find("itemImage")?.GetComponent<Image>();
        itemPriceText   ??= transform.Find("itemPriceText")?.GetComponent<TMP_Text>();

        if (shop_Manager == null) Debug.LogError($"{name}: SHOP_Manager is missing in SHOP_Slot");
        if (inv_ItemInfo == null) Debug.LogError($"{name}: INV_ItemInfo is missing in SHOP_Slot");
        if (itemImage == null)    Debug.LogError($"{name}: itemImage is missing in SHOP_Slot");
        if (itemNameText == null) Debug.LogError($"{name}: itemNameText is missing in SHOP_Slot");
        if (itemPriceText == null)Debug.LogError($"{name}: itemPriceText is missing in SHOP_Slot");
    }

    // called by SHOP_Manager at startup
    public void Initialize(INV_ItemSO itemSO)
    {
        this.itemSO = itemSO;
        price = itemSO.price;

        itemImage.enabled = true;
        itemImage.sprite = itemSO.image;
        itemNameText.text = itemSO.itemName;
        itemPriceText.text = price.ToString();
    }

    // called by Buy button
    public void OnBuyButtonClicked()
    {
        shop_Manager.TryBuyItem(itemSO, price);
    }
    
    // Show item info on hover
    public void OnPointerEnter(PointerEventData eventData)
    {
        if (itemSO) inv_ItemInfo.Show(itemSO);
    }

    // Hide item info when not hovering
    public void OnPointerExit(PointerEventData eventData)
    {
        inv_ItemInfo.Hide();
    }

    // Follow mouse while hovering
    public void OnPointerMove(PointerEventData eventData)
    {
        if (itemSO) inv_ItemInfo.FollowMouse(eventData.position);
    }
}

